<span class="keyword">class</span> <span class="entity class">Boid</span>&nbsp;{

  <span class="keyword">int</span> size <span class="operator">=</span> <span class="integer">2</span>;
  <span class="keyword">int</span> <span class="static">COLOR_NUM</span> <span class="operator">=</span> <span class="integer">20</span>;
  <span class="keyword">int</span> <span class="static">RANDOM_COLOR_CHANGE</span> <span class="operator">=</span> <span class="integer">10</span>;
  <span class="keyword">float</span> visionCone <span class="operator">=</span> <span class="static">PI</span><span class="operator">/</span><span class="integer">6</span>;
  <span class="keyword">float</span> comfortZone <span class="operator">=</span> <span class="integer">15</span><span class="operator">*</span>size;
  <span class="keyword">float</span> eyeSight <span class="operator">=</span> <span class="integer">37</span><span class="operator">*</span>size;
  <span class="keyword">float</span> colorVision <span class="operator">=</span> <span class="integer">30</span><span class="operator">*</span>size;
  <span class="keyword">float</span> speedLimit <span class="operator">=</span> <span class="integer">6</span><span class="operator">*</span>size;
  <span class="keyword">float</span> forceLimit <span class="operator">=</span> <span class="operator">.</span><span class="integer">03</span><span class="operator">*</span>size;

  <span class="keyword">float</span> sepWeight <span class="operator">=</span> <span class="integer">125</span>;
  <span class="keyword">float</span> aliWeight <span class="operator">=</span> <span class="integer">35</span>;
  <span class="keyword">float</span> cohWeight <span class="operator">=</span> <span class="integer">10</span>; 

  <span class="entity class">PVector</span> position;
  <span class="entity class">PVector</span> velocity;
  <span class="entity class">PVector</span> steeringForce;

  <span class="keyword">float</span> <span class="static">H</span>, <span class="static">S</span>, <span class="static">B</span>;

  <span class="keyword">public</span> <span class="entity function">Boid</span>(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> <span class="static">H_</span>){
    position <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(x, y);
    <span class="keyword">float</span> angle <span class="operator">=</span> <span class="entity function">random</span>(<span class="static">TWO_PI</span>);
    velocity <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector(cos</span>(angle), <span class="entity function">sin</span>(angle));
    <span class="static">H</span> <span class="operator">=</span> <span class="static">H_</span>;
    <span class="static">S</span> <span class="operator">=</span> <span class="entity function">(float)</span>(<span class="entity class">Math</span><span class="operator">.</span><span class="entity function">random</span>()<span class="operator">*</span><span class="integer">50</span>)<span class="operator">+</span><span class="integer">50</span>;
    <span class="static">B</span> <span class="operator">=</span> <span class="entity function">(float)</span>(<span class="entity class">Math</span><span class="operator">.</span><span class="entity function">random</span>()<span class="operator">*</span><span class="integer">50</span>) <span class="operator">+</span> <span class="integer">50</span>;

  }

  <span class="keyword">void</span> <span class="entity function">update</span>(<span class="entity class">ArrayList</span><span class="operator">&lt;</span><span class="entity class">Boid</span><span class="operator">&gt;</span> flock){

    steeringForce <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(<span class="integer">0</span>,<span class="integer">0</span>);
    steeringForce<span class="operator">.</span><span class="entity function">add(forces</span>(flock));
    velocity<span class="operator">.</span><span class="entity function">mult</span>(<span class="operator">.</span><span class="integer">5</span>);
    velocity<span class="operator">.</span><span class="entity function">add</span>(steeringForce);
    <span class="entity function">if</span>(velocity<span class="operator">.</span><span class="entity function">mag</span>()<span class="operator">&lt;</span><span class="integer">1</span>)
      velocity<span class="operator">.</span><span class="entity function">mult</span>(<span class="integer">2</span>);
    velocity<span class="operator">.</span><span class="entity function">limit</span>(speedLimit);
    position<span class="operator">.</span><span class="entity function">add</span>(velocity);

    <span class="keyword">if</span> (position<span class="operator">.</span>x <span class="operator">&lt;</span> size){
      position<span class="operator">.</span>x <span class="operator">=</span> width<span class="operator">-</span>size;
    }
    <span class="keyword">if</span> (position<span class="operator">.</span>y <span class="operator">&lt;</span> size) {
      position<span class="operator">.</span>y <span class="operator">=</span> height<span class="operator">-</span>size;
    }
    <span class="keyword">if</span> (position<span class="operator">.</span>x <span class="operator">&gt;</span> width<span class="operator">-</span>size) {
      position<span class="operator">.</span>x <span class="operator">=</span> size;
    }
    <span class="keyword">if</span> (position<span class="operator">.</span>y <span class="operator">&gt;</span> height<span class="operator">-</span>size){
      position<span class="operator">.</span>y <span class="operator">=</span> size;
    }
  }

  <span class="entity class">PVector</span> <span class="entity function">forces</span>(<span class="entity class">ArrayList</span><span class="operator">&lt;</span><span class="entity class">Boid</span><span class="operator">&gt;</span> flock){
    <span class="entity class">PVector</span> steering <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(<span class="integer">0</span>,<span class="integer">0</span>);
    <span class="entity class">PVector</span> separation <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(<span class="integer">0</span>,<span class="integer">0</span>);
    <span class="entity class">PVector</span> alignment <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(<span class="integer">0</span>,<span class="integer">0</span>);
    <span class="entity class">PVector</span> cohesion <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(<span class="integer">0</span>,<span class="integer">0</span>);

    <span class="entity class">PVector</span> mouse <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(mouseX, mouseY);

    <span class="keyword">int</span> sepCount <span class="operator">=</span> <span class="integer">0</span>;
    <span class="keyword">int</span> counter <span class="operator">=</span> <span class="integer">0</span>;
    <span class="keyword">int</span> colorCount <span class="operator">=</span> <span class="integer">0</span>;
    <span class="keyword">float</span> frontColor <span class="operator">=</span> <span class="integer">0</span>;

    <span class="entity function">for</span>(<span class="entity class">Boid</span> b<span class="operator">:</span> flock){
      <span class="comment">//check if within eyesight for cohesion and alignment</span>
      <span class="keyword">float</span> dist <span class="operator">=</span><span class="entity class">PVector</span><span class="operator">.</span><span class="entity function">dist</span>(<span class="keyword">this</span><span class="operator">.</span>position, b<span class="operator">.</span>position);
      <span class="entity function">if</span>(dist <span class="operator">&lt;</span> eyeSight <span class="operator">&amp;&amp;</span> dist <span class="operator">!</span><span class="operator">=</span> <span class="integer">0</span>){ 
        <span class="comment">//alignment</span>
        counter<span class="operator">++</span>;
        <span class="entity class">PVector</span> temp <span class="operator">=</span> <span class="keyword">new</span> <span class="entity function">PVector</span>(b<span class="operator">.</span>velocity<span class="operator">.</span>x, b<span class="operator">.</span>velocity<span class="operator">.</span>y);
        temp<span class="operator">.</span><span class="entity function">normalize</span>();
        temp<span class="operator">.</span><span class="entity function">div</span>(dist);
        alignment<span class="operator">.</span><span class="entity function">add</span>(temp);

        <span class="comment">//cohesion</span>
        temp <span class="operator">=</span> <span class="entity class">PVector</span><span class="operator">.</span><span class="entity function">sub</span>(b<span class="operator">.</span>position, position);
        temp<span class="operator">.</span><span class="entity function">normalize</span>();
        temp<span class="operator">.</span><span class="entity function">div</span>(dist);
        temp<span class="operator">.</span><span class="entity function">mult</span>(<span class="integer">100</span>);
        cohesion<span class="operator">.</span><span class="entity function">add</span>(temp);
      }
      <span class="comment">//separation</span>
      <span class="entity function">if</span>(dist <span class="operator">&lt;</span> comfortZone <span class="operator">&amp;&amp;</span> dist <span class="operator">&gt;</span> <span class="integer">0</span>){
        <span class="entity class">PVector</span> temp <span class="operator">=</span> <span class="entity class">PVector</span><span class="operator">.</span><span class="entity function">sub</span>(position, b<span class="operator">.</span>position);
        temp<span class="operator">.</span><span class="entity function">normalize</span>();
        temp<span class="operator">.</span><span class="entity function">div</span>(dist);
        temp<span class="operator">.</span><span class="entity function">mult</span>(<span class="integer">100</span>);
        separation<span class="operator">.</span><span class="entity function">add</span>(temp);
        sepCount<span class="operator">++</span>;
      }

      <span class="entity function">if</span>(dist <span class="operator">&lt;</span> colorVision <span class="operator">&amp;&amp;</span> dist<span class="operator">&gt;</span><span class="integer">0</span>){
        <span class="comment">//color</span>
        <span class="entity class">PVector</span> disp <span class="operator">=</span> <span class="entity class">PVector</span><span class="operator">.</span><span class="entity function">sub</span>(b<span class="operator">.</span>position, <span class="keyword">this</span><span class="operator">.</span>position);
        <span class="keyword">float</span> head <span class="operator">=</span> <span class="entity function">heading2D</span>(disp);
        <span class="comment">//if the other boid is ahead of this one</span>
        <span class="entity function">if</span>(<span class="entity class">Math</span><span class="operator">.</span><span class="entity function">abs(head-heading2D</span>(velocity))<span class="operator">&lt;</span><span class="static">PI</span><span class="operator">/</span><span class="integer">2</span> <span class="operator">&amp;&amp;</span> <span class="entity class">Math</span><span class="operator">.</span><span class="entity function">abs(head-heading2D</span>(b<span class="operator">.</span>velocity)) <span class="operator">&lt;</span> visionCone){
          frontColor <span class="operator">+</span><span class="operator">=</span> b<span class="operator">.</span><span class="static">H</span>;
          colorCount<span class="operator">++</span>;
        }
      }     
    } 
    <span class="entity function">if</span>(colorCount<span class="operator">==</span><span class="integer">0</span>){

    } <span class="keyword">else</span> <span class="keyword">if</span> (colorCount <span class="operator">&gt;</span> <span class="integer">3</span>){
      <span class="keyword">float</span> otherColor <span class="operator">=</span> frontColor<span class="operator">/</span>colorCount;
      <span class="static">H</span> <span class="operator">=</span> otherColor;
    } <span class="keyword">else</span> {
      <span class="keyword">float</span> otherColor <span class="operator">=</span> frontColor<span class="operator">/</span>colorCount;
      <span class="static">H</span> <span class="operator">=</span> (otherColor <span class="operator">+</span> <span class="static">H</span>)<span class="operator">/</span><span class="integer">2</span>;
    }

    mouse<span class="operator">.</span><span class="entity function">sub</span>(position);
    <span class="keyword">float</span> dist <span class="operator">=</span> mouse<span class="operator">.</span><span class="entity function">mag</span>();
    mouse<span class="operator">.</span><span class="entity function">normalize</span>();
    mouse<span class="operator">.</span><span class="entity function">div</span>(dist);
    mouse<span class="operator">.</span><span class="entity function">mult</span>(<span class="integer">5</span>);  
    <span class="entity function">if</span>(<span class="operator">!</span>mousePressed){
      <span class="entity function">if</span>(keyPressed){
        <span class="entity function">if</span>(key <span class="operator">==</span> <span class="char">' '</span>){
          steering<span class="operator">.</span><span class="entity function">sub</span>(mouse);
        }
      }
    }

    <span class="entity function">if</span>(counter <span class="operator">&gt;</span> <span class="integer">0</span>)
      alignment<span class="operator">.</span><span class="entity function">div</span>(counter);
    <span class="entity function">if</span>(counter <span class="operator">&gt;</span> <span class="integer">0</span>)
      cohesion<span class="operator">.</span><span class="entity function">div</span>(counter);
    <span class="entity function">if</span>(sepCount <span class="operator">&gt;</span> <span class="integer">0</span>)
      separation<span class="operator">.</span><span class="entity function">div</span>(sepCount); 

    alignment<span class="operator">.</span><span class="entity function">mult</span>(aliWeight);
    alignment<span class="operator">.</span><span class="entity function">limit</span>(forceLimit);
    steering<span class="operator">.</span><span class="entity function">add</span>(alignment);

    cohesion<span class="operator">.</span><span class="entity function">mult</span>(cohWeight);
    cohesion<span class="operator">.</span><span class="entity function">limit</span>(forceLimit);
    steering<span class="operator">.</span><span class="entity function">add</span>(cohesion);

    separation<span class="operator">.</span><span class="entity function">mult</span>(sepWeight);
    separation<span class="operator">.</span><span class="entity function">limit</span>(forceLimit);
    steering<span class="operator">.</span><span class="entity function">add</span>(separation);

    <span class="keyword">return</span> steering;
  }


  <span class="keyword">void</span> <span class="entity function">render</span>() {
    <span class="static">H</span> <span class="operator">%</span><span class="operator">=</span> <span class="integer">360</span>;
    <span class="comment">// Draw a triangle rotated in the direction of velocity</span>
    <span class="keyword">float</span> theta <span class="operator">=</span> <span class="entity function">heading2D</span>(velocity) <span class="operator">+</span> <span class="static">PI</span><span class="operator">/</span><span class="integer">2</span>;
    <span class="comment">// heading2D() above is now heading() but leaving old syntax until Processing.js catches up</span>
    <span class="entity function">colorMode</span>(<span class="static">HSB</span>, <span class="integer">360</span>, <span class="integer">100</span>, <span class="integer">100</span>);
    <span class="entity function">fill</span>(<span class="static">H</span>,<span class="static">S</span>,<span class="static">B</span>);
    <span class="entity function">noStroke</span>();
    <span class="entity function">pushMatrix</span>();
    <span class="entity function">translate</span>(position<span class="operator">.</span>x, position<span class="operator">.</span>y);
    <span class="entity function">rotate</span>(theta);
    <span class="entity function">beginShape</span>(<span class="static">TRIANGLES</span>);
    <span class="entity function">vertex</span>(<span class="integer">0</span>, size);
    <span class="entity function">vertex</span>(<span class="operator">-</span><span class="integer">2</span><span class="operator">*</span>size,<span class="integer">4</span><span class="operator">*</span>size);
    <span class="entity function">vertex</span>(<span class="integer">2</span><span class="operator">*</span>size, <span class="integer">4</span><span class="operator">*</span>size);
    <span class="entity function">endShape</span>();
    <span class="entity function">ellipseMode</span>(<span class="static">CENTER</span>);
    <span class="entity function">ellipse</span>(<span class="integer">0</span>,<span class="operator">-</span>size,<span class="integer">2</span><span class="operator">*</span>size,<span class="integer">6</span><span class="operator">*</span>size);
    <span class="entity function">popMatrix</span>();
  }

  <span class="keyword">float</span> <span class="entity function">heading2D</span>(<span class="entity class">PVector</span> pvect){
    <span class="keyword">return</span> <span class="entity function">(float)</span>(<span class="entity class">Math</span><span class="operator">.</span><span class="entity function">atan2</span>(pvect<span class="operator">.</span>y, pvect<span class="operator">.</span>x));  
  }

  <span class="keyword">void</span> <span class="entity function">rotate2D</span>(<span class="entity class">PVector</span> v, <span class="keyword">float</span> theta) {
    <span class="keyword">float</span> xTemp <span class="operator">=</span> v<span class="operator">.</span>x;
    v<span class="operator">.</span>x <span class="operator">=</span> v<span class="operator">.</span><span class="entity function">x*cos</span>(theta) <span class="operator">-</span> v<span class="operator">.</span><span class="entity function">y*sin</span>(theta);
    v<span class="operator">.</span>y <span class="operator">=</span> <span class="entity function">xTemp*sin</span>(theta) <span class="operator">+</span> v<span class="operator">.</span><span class="entity function">y*cos</span>(theta);
  }

}
